// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Session {
  id                  String   @id
  shop                String
  state               String
  isOnline            Boolean  @default(false)
  scope               String?
  expires             DateTime?
  accessToken         String
  userId              BigInt?
  firstName           String?
  lastName            String?
  email               String?
  accountOwner        Boolean  @default(false)
  locale              String?
  collaborator        Boolean? @default(false)
  emailVerified       Boolean? @default(false)
  refreshToken        String?
  refreshTokenExpires DateTime?
}

enum LedgerType {
  EARN
  REVERSAL
  REDEEM
  ADJUST
  EXPIRY
}

enum RedemptionStatus {
  ISSUED
  APPLIED
  CONSUMED
  VOID
  EXPIRED
  CANCELLED
}

enum WebhookOutcome {
  RECEIVED
  PROCESSED
  SKIPPED
  FAILED
}

model ShopSettings {
  shop                      String   @id
  earnRate                   Int      @default(1)
  redemptionMinOrder         Int      @default(0)

  pointsExpireInactivityDays Int      @default(365)
  redemptionExpiryHours      Int      @default(72)

  eligibleCollectionHandle   String   @default("lcr_loyalty_eligible")
  // Cached GID for the eligible collection (optional)
  eligibleCollectionGid      String?

  excludedCustomerTags       Json?
  includeProductTags         Json?
  excludeProductTags         Json?
  redemptionSteps            Json?
  redemptionValueMap         Json?

  createdAt                  DateTime @default(now())
  updatedAt                  DateTime @updatedAt
}

model CustomerPointsBalance {
  id               String   @id @default(cuid())
  shop             String
  customerId       String
  balance          Int      @default(0)
  lifetimeEarned   Int      @default(0)
  lifetimeRedeemed Int      @default(0)

  lastActivityAt   DateTime @default(now())
  expiredAt        DateTime?

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@unique([shop, customerId], name: "shop_customerId")
}

model PointsLedger {
  id          String   @id @default(cuid())
  shop        String
  customerId  String
  type        LedgerType
  delta       Int
  source      String
  sourceId    String
  description String?
  createdAt   DateTime @default(now())

  @@unique([shop, customerId, type, source, sourceId], name: "ledger_dedupe")
  @@unique([shop, type, source, sourceId], name: "ledger_refund_dedupe")
  @@index([shop, customerId, createdAt])
}

model Redemption {
  id              String           @id @default(cuid())
  shop            String
  customerId      String
  status          RedemptionStatus @default(ISSUED)

  points          Int
  valueDollars    Int
  code            String
  discountNodeId  String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  expiresAt       DateTime?

  appliedAt       DateTime?
  consumedAt      DateTime?
  consumedOrderId String?

  voidedAt        DateTime?
  expiredAt       DateTime?
  restoredAt      DateTime?
  restoreReason   String?

  idemKey         String?

  @@unique([shop, customerId, idemKey], name: "redemption_idem")
  @@unique([shop, code], name: "shop_code")
  @@index([shop, customerId, status])
}

model WebhookEvent {
  id             String         @id @default(cuid())
  shop           String
  topic          String
  webhookId      String
  resourceId     String
  receivedAt     DateTime       @default(now())
  payload        Json
  outcome        WebhookOutcome @default(RECEIVED)
  outcomeMessage String?
  processedAt    DateTime?

  @@unique([shop, webhookId], name: "shop_webhookId")
  @@index([shop, topic, receivedAt])
}

model PrivacyEvent {
  id          String   @id @default(cuid())
  shop        String
  topic       String
  payloadJson Json
  receivedAt  DateTime @default(now())

  @@index([shop, topic, receivedAt])
}

model OrderPointsSnapshot {
  id                     String   @id @default(cuid())
  shop                   String
  orderId                String
  orderName              String?
  customerId             String

  eligibleNetMerchandise Int      @default(0) // cents
  pointsAwarded          Int      @default(0)
  pointsReversedToDate   Int      @default(0)

  paidAt                 DateTime
  cancelledAt            DateTime?
  discountCodesJson      Json?

  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  @@unique([shop, orderId], name: "shop_orderId")
  @@index([shop, customerId, paidAt])
}
