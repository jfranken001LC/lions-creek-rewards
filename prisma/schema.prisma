// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Session {
  id                  String   @id
  shop                String
  state               String
  isOnline            Boolean  @default(false)
  scope               String?
  expires             DateTime?
  accessToken         String
  userId              BigInt?
  firstName           String?
  lastName            String?
  email               String?
  accountOwner        Boolean  @default(false)
  locale              String?
  collaborator        Boolean? @default(false)
  emailVerified       Boolean? @default(false)
  refreshToken        String?
  refreshTokenExpires DateTime?
}

enum LedgerType {
  EARN
  REVERSAL
  REDEEM
  ADJUST
  EXPIRY
}

enum RedemptionStatus {
  ISSUED
  APPLIED
  CONSUMED
  VOID
  EXPIRED
  CANCELLED
}

enum WebhookOutcome {
  RECEIVED
  PROCESSED
  SKIPPED
  FAILED
}

model ShopSettings {
  shop                      String   @id
  earnRate                   Int      @default(1)
  redemptionMinOrder         Int      @default(0)

  // REQUIRED by jobs.expire + API payload
  pointsExpireInactivityDays Int      @default(365)

  // REQUIRED by redemption expiry logic + API payload
  redemptionExpiryHours      Int      @default(72)

  eligibleCollectionHandle   String   @default("lcr_loyalty_eligible")
  excludedCustomerTags       Json?
  includeProductTags         Json?
  excludeProductTags         Json?
  redemptionSteps            Json?
  redemptionValueMap         Json?
  updatedAt                  DateTime @default(now())
}

model CustomerPointsBalance {
  id             String   @id @default(cuid())
  shop           String
  customerId     String
  balance        Int      @default(0)
  lifetimeEarned Int      @default(0)
  lifetimeRedeemed Int    @default(0)
  lastActivityAt DateTime?
  expiredAt      DateTime?

  @@unique([shop, customerId], name: "shop_customerId")
}

model PointsLedger {
  id          String   @id @default(cuid())
  shop        String
  customerId  String
  type        LedgerType
  delta       Int
  source      String
  sourceId    String
  description String?
  createdAt   DateTime @default(now())

  @@unique([shop, customerId, type, source, sourceId], name: "ledger_dedupe")
  @@unique([shop, type, source, sourceId], name: "ledger_refund_dedupe")
  @@index([shop, customerId, createdAt])
}

model Redemption {
  id           String           @id @default(cuid())
  shop         String
  customerId   String
  status       RedemptionStatus @default(ISSUED)
  points       Int
  valueDollars Int
  code         String
  discountNodeId String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @default(now())
  expiresAt    DateTime?
  consumedAt   DateTime?
  voidedAt     DateTime?
  expiredAt    DateTime?
  restoredAt   DateTime?
  restoreReason String?

  idemKey      String?

  @@unique([shop, customerId, idemKey], name: "redemption_idem")
  @@index([shop, customerId, status])
}

model WebhookEvent {
  id         String         @id @default(cuid())
  shop       String
  topic      String
  webhookId  String?
  payload    Json
  outcome    WebhookOutcome @default(RECEIVED)
  error      String?
  processedAt DateTime?
  createdAt  DateTime @default(now())

  @@index([shop, topic, createdAt])
}
